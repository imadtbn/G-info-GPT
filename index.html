<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ูุธุงู ุฅุฏุงุฑุฉ ุญุถูุฑุฉ ุงูุฅุนูุงู ุงูุขูู โ ูุญูู</title>
  <meta name="description" content="ููุญุฉ ุชุญูู ูุญููุฉ ูุฅุฏุงุฑุฉ ุงูุฃุฌูุฒุฉุ ุงููุณุชุฎุฏูููุ C12 (ุชุณููู)ุ C7 (ุตูุงูุฉ)ุ ุญูุธ ุชููุงุฆูุ ูุงุณุชูุฑุงุฏ/ุชุตุฏูุฑ Excel." />  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>  <style>
    body{font-family: 'Cairo', sans-serif}
    @media print{.no-print{display:none!important}}
    .badge{display:inline-block;padding:4px 8px;border-radius:8px;font-size:12px}
  </style></head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <div class="min-h-screen grid grid-cols-1 lg:grid-cols-[260px_1fr]">
    <aside class="bg-white dark:bg-gray-950 border-r dark:border-gray-800 p-4">
      <div class="flex items-center gap-3 mb-6">
        <div class="text-2xl">๐ฅ๏ธ</div>
        <div class="font-bold text-lg">ุญุถูุฑุฉ ุงูุฅุนูุงู ุงูุขูู</div>
      </div>
      <nav class="space-y-2">
        <button data-tab="dashboard" class="tabBtn w-full text-right px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">ููุญุฉ ุงูุชุญูู</button>
        <button data-tab="devices" class="tabBtn w-full text-right px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">ุงูุฃุฌูุฒุฉ</button>
        <button data-tab="users" class="tabBtn w-full text-right px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">ุงููุณุชุฎุฏููู</button>
        <button data-tab="c12" class="tabBtn w-full text-right px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">C12 - ุงูุชุณููู</button>
        <button data-tab="c7" class="tabBtn w-full text-right px-3 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800">C7 - ุงูุตูุงูุฉ</button>
        <div class="mt-4 border-t pt-3">
          <button id="exportAll" class="w-full text-right px-3 py-2 rounded-lg bg-green-600 text-white">ุชุตุฏูุฑ ูู ุงูุจูุงูุงุช</button>
          <label class="w-full block mt-2 cursor-pointer rounded-lg border px-3 py-2 text-right"><i class="fa-solid fa-upload"></i> ุงุณุชูุฑุงุฏ ููู Excel
            <input id="importAll" type="file" accept=".xlsx,.xls" class="hidden" />
          </label>
          <button id="resetData" class="w-full mt-2 text-right px-3 py-2 rounded-lg border">ุชููุฆุฉ ูุงุนุฏุฉ ุจูุงูุงุช ุฌุฏูุฏุฉ</button>
        </div>
      </nav>
    </aside><main class="p-6">
  <!-- Dashboard -->
  <section id="dashboard" class="tabContent">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold">ููุญุฉ ุงูุชุญูู</h1>
      <div class="text-sm text-gray-600">ุญูุธ ุชููุงุฆู: <span id="autoSaveStatus">ุฌุงูุฒ</span></div>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="p-4 bg-white rounded-lg shadow-sm dark:bg-gray-800">
        <div class="text-sm text-gray-500">ุฅุฌูุงูู ุงูุฃุฌูุฒุฉ</div>
        <div id="statDevices" class="text-2xl font-bold">0</div>
      </div>
      <div class="p-4 bg-white rounded-lg shadow-sm dark:bg-gray-800">
        <div class="text-sm text-gray-500">ุฃุฌูุฒุฉ ูุชุตูุฉ ุจุงูุดุจูุฉ</div>
        <div id="statOnline" class="text-2xl font-bold">0</div>
      </div>
      <div class="p-4 bg-white rounded-lg shadow-sm dark:bg-gray-800">
        <div class="text-sm text-gray-500">ุฃูุฑุงู C12</div>
        <div id="statC12" class="text-2xl font-bold">0</div>
      </div>
      <div class="p-4 bg-white rounded-lg shadow-sm dark:bg-gray-800">
        <div class="text-sm text-gray-500">ุฃูุฑุงู C7 (ููุฏ ุงูุฅุตูุงุญ)</div>
        <div id="statC7Repair" class="text-2xl font-bold">0</div>
      </div>
    </div>
    <div class="mb-6">
      <h3 class="font-bold mb-2">ุจุญุซ ุณุฑูุน</h3>
      <input id="globalSearch" placeholder="ุงุจุญุซ ุจุงุณู ุงูุฌูุงุฒ ุฃู ุงูุฑูู ุงูุชุณูุณูู ุฃู ุงุณู ุงููุณุชุฎุฏู..." class="w-full rounded-lg border px-3 py-2 bg-white dark:bg-gray-800" />
    </div>
    <div>
      <h3 class="font-bold mb-2">ุขุฎุฑ ุงูุชุนุฏููุงุช</h3>
      <ul id="recentList" class="list-disc pl-6 text-sm text-gray-700 dark:text-gray-300"></ul>
    </div>
  </section>

  <!-- Devices -->
  <section id="devices" class="tabContent hidden">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold">ุงูุฃุฌูุฒุฉ</h2>
      <button id="addDeviceBtn" class="px-4 py-2 rounded-lg bg-primary-600 text-white">ุฅุถุงูุฉ ุฌูุงุฒ ุฌุฏูุฏ</button>
    </div>
    <div class="overflow-auto bg-white rounded-lg dark:bg-gray-800 p-2">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50 dark:bg-gray-900">
          <tr>
            <th class="px-3 py-2 text-right">#</th>
            <th class="px-3 py-2 text-right">ุงุณู ุงูุฌูุงุฒ</th>
            <th class="px-3 py-2 text-right">ุงููุณุชุฎุฏู</th>
            <th class="px-3 py-2 text-right">ุงูุฑูู ุงูุชุณูุณูู</th>
            <th class="px-3 py-2 text-right">ุงูุดุจูุฉ</th>
            <th class="px-3 py-2 text-right">ูุธุงู ุงูุชุดุบูู</th>
            <th class="px-3 py-2 text-right">ูุถุงุฏ ุงูููุฑูุณุงุช</th>
            <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
          </tr>
        </thead>
        <tbody id="devicesTbody"></tbody>
      </table>
    </div>
  </section>

  <!-- Users -->
  <section id="users" class="tabContent hidden">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold">ูุงุฆูุฉ ุงููุณุชุฎุฏููู</h2>
      <button id="addUserBtn" class="px-4 py-2 rounded-lg bg-primary-600 text-white">ุฅุถุงูุฉ ูุณุชุฎุฏู</button>
    </div>
    <div class="bg-white rounded-lg p-3 dark:bg-gray-800">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50 dark:bg-gray-900">
          <tr>
            <th class="px-3 py-2 text-right">#</th>
            <th class="px-3 py-2 text-right">ุงูุงุณู</th>
            <th class="px-3 py-2 text-right">ุงูุงุฎุชุตุงุต</th>
            <th class="px-3 py-2 text-right">ุงูุดูุงุฏุงุช</th>
            <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
          </tr>
        </thead>
        <tbody id="usersTbody"></tbody>
      </table>
    </div>
  </section>

  <!-- C12 -->
  <section id="c12" class="tabContent hidden">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold">ูุซุงุฆู C12 - ุชุณููู/ุงุณุชุฑุฌุงุน</h2>
      <button id="addC12Btn" class="px-4 py-2 rounded-lg bg-primary-600 text-white">ุฅูุดุงุก ูุซููุฉ C12</button>
    </div>
    <div class="bg-white rounded-lg p-3 dark:bg-gray-800">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50 dark:bg-gray-900">
          <tr>
            <th class="px-3 py-2 text-right">#</th>
            <th class="px-3 py-2 text-right">ุฑูู ุงููุซููุฉ</th>
            <th class="px-3 py-2 text-right">ุงูุชุงุฑูุฎ</th>
            <th class="px-3 py-2 text-right">ุงูุฌูุงุฒ</th>
            <th class="px-3 py-2 text-right">ุงููุณุชูู</th>
            <th class="px-3 py-2 text-right">ุงูุฌูุฉ</th>
            <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
          </tr>
        </thead>
        <tbody id="c12Tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- C7 -->
  <section id="c7" class="tabContent hidden">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold">ูุซุงุฆู C7 - ุตูุงูุฉ</h2>
      <button id="addC7Btn" class="px-4 py-2 rounded-lg bg-primary-600 text-white">ุฅูุดุงุก ูุฑูุฉ ุตูุงูุฉ</button>
    </div>
    <div class="bg-white rounded-lg p-3 dark:bg-gray-800">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50 dark:bg-gray-900">
          <tr>
            <th class="px-3 py-2 text-right">#</th>
            <th class="px-3 py-2 text-right">ุฑูู ุงููุซููุฉ</th>
            <th class="px-3 py-2 text-right">ุงูุชุงุฑูุฎ</th>
            <th class="px-3 py-2 text-right">ุงูุฌูุงุฒ</th>
            <th class="px-3 py-2 text-right">ุงูุนุทู</th>
            <th class="px-3 py-2 text-right">ุงูุญุงูุฉ</th>
            <th class="px-3 py-2 text-right">ุฅุฌุฑุงุกุงุช</th>
          </tr>
        </thead>
        <tbody id="c7Tbody"></tbody>
      </table>
    </div>
  </section>

</main>

  </div>  <!-- ููุงุฐุฌ ูุฎููุฉ -->  <div id="modals" class="fixed inset-0 z-50 hidden items-center justify-center p-4 bg-black/40">
    <div id="modalContent" class="bg-white dark:bg-gray-900 rounded-lg w-full max-w-2xl p-4"></div>
  </div>  <script>
    // ======= ููุงุชูุญ ุงูุชุฎุฒูู ======
    const KEYS = { DEV:'devices', USERS:'users', C12:'c12', C7:'c7', COUNTERS:'counters', RECENT:'recent' }

    // ==== ูุณุงุนุฏุฉ DOM =====
    const $ = s => document.querySelector(s)
    const $$ = s => Array.from(document.querySelectorAll(s))

    // ==== ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงููุญููุฉ ุฅุฐุง ูู ุชูู ููุฌูุฏุฉ =====
    function initDB(){
      if(!localStorage.getItem(KEYS.DEV)){
        localStorage.setItem(KEYS.DEV, JSON.stringify([]))
      }
      if(!localStorage.getItem(KEYS.USERS)) localStorage.setItem(KEYS.USERS, JSON.stringify([]))
      if(!localStorage.getItem(KEYS.C12)) localStorage.setItem(KEYS.C12, JSON.stringify([]))
      if(!localStorage.getItem(KEYS.C7)) localStorage.setItem(KEYS.C7, JSON.stringify([]))
      if(!localStorage.getItem(KEYS.COUNTERS)) localStorage.setItem(KEYS.COUNTERS, JSON.stringify({ dev:0, user:0, c12:0, c7:0 }))
      if(!localStorage.getItem(KEYS.RECENT)) localStorage.setItem(KEYS.RECENT, JSON.stringify([]))
    }

    function load(key){ try{return JSON.parse(localStorage.getItem(key))||[]}catch{return []} }
    function save(key, data){ localStorage.setItem(key, JSON.stringify(data)); autoSaveNotice(); }

    // ุญูุธ ุชููุงุฆู - ุฅุธูุงุฑ ุญุงูุฉ
    let saveTimer = null
    function autoSaveNotice(){
      $('#autoSaveStatus').textContent = 'ุชู ุงูุญูุธ ุชููุงุฆูุงู โ ' + new Date().toLocaleTimeString()
      clearTimeout(saveTimer)
      saveTimer = setTimeout(()=>{ $('#autoSaveStatus').textContent = 'ุฌุงูุฒ' }, 3000)
      pushRecent('ุญูุธ ุงูุจูุงูุงุช ูุญูููุง')
    }

    function pushRecent(txt){
      const recent = load(KEYS.RECENT)
      recent.unshift({t:new Date().toLocaleString(),msg:txt})
      if(recent.length>10) recent.pop()
      save(KEYS.RECENT, recent)
      renderRecent()
    }

    function renderRecent(){
      const list = load(KEYS.RECENT)
      const ul = $('#recentList'); ul.innerHTML=''
      list.forEach(it => { const li=document.createElement('li'); li.textContent = `${it.t} โ ${it.msg}`; ul.appendChild(li) })
    }

    // ====== ุนูุงุตุฑ ุงูุชุจููุจ ======
    $$('.tabBtn').forEach(btn=>btn.addEventListener('click', ()=>{
      const tab = btn.dataset.tab
      $$('.tabContent').forEach(s=>s.classList.add('hidden'))
      $(`#${tab}`).classList.remove('hidden')
      renderAll()
    }))

    // ======= ุฑูุฏุฑ ุนุงู ======
    function renderAll(){ renderStats(); renderDevices(); renderUsers(); renderC12(); renderC7(); renderRecent(); }

    function renderStats(){
      const devs = load(KEYS.DEV)
      $('#statDevices').textContent = devs.length
      $('#statOnline').textContent = devs.filter(d=>d.network && d.network.connected).length
      $('#statC12').textContent = load(KEYS.C12).length
      $('#statC7Repair').textContent = load(KEYS.C7).filter(x=>x.status==='ููุฏ ุงูุฅุตูุงุญ').length
    }

    // ======== ุงูุฃุฌูุฒุฉ ========
    function renderDevices(){
      const arr = load(KEYS.DEV)
      const tbody = $('#devicesTbody'); tbody.innerHTML=''
      arr.forEach((d,i)=>{
        const tr = document.createElement('tr')
        tr.className = i%2? 'bg-gray-50/50':' '
        tr.innerHTML = `
          <td class="px-3 py-2">${i+1}</td>
          <td class="px-3 py-2">${d.name}</td>
          <td class="px-3 py-2">${d.userName||''}</td>
          <td class="px-3 py-2">${d.sn}</td>
          <td class="px-3 py-2">${d.network && d.network.connected ? `<span class=\"badge bg-green-100 text-green-800\">ูุชุตู (${d.network.ip||''})</span>` : `<span class=\"badge bg-red-100 text-red-800\">ูุนุฒูู</span>`}</td>
          <td class="px-3 py-2">${d.osName||''}<br><small>ุขุฎุฑ ุชุญุฏูุซ: ${d.osLastUpdate||''}</small></td>
          <td class="px-3 py-2">${d.avStatus||''}<br><small>${d.avScan||''}</small></td>
          <td class="px-3 py-2">
            <button data-id="${d.id}" class="editDevice px-2 py-1 rounded border">ุชุนุฏูู</button>
            <button data-id="${d.id}" class="delDevice px-2 py-1 rounded border ml-2">ุญุฐู</button>
          </td>`
        tbody.appendChild(tr)
      })
      // ุฃุญุฏุงุซ ุงูุฃุฒุฑุงุฑ
      $$('.editDevice').forEach(b=>b.addEventListener('click', e=>openDeviceModal(e.target.dataset.id)))
      $$('.delDevice').forEach(b=>b.addEventListener('click', e=>deleteDevice(e.target.dataset.id)))
    }

    function openDeviceModal(id){
      const dev = load(KEYS.DEV).find(x=>x.id==id) || null
      const html = renderDeviceForm(dev)
      openModal(html)
      attachDeviceFormHandlers(dev)
    }

    function renderDeviceForm(dev){
      const isNew = !dev
      const d = dev || { name:'', userId:'', userName:'', sn:'', cpu:'', monitor:'', mouse:'', keyboard:'', printer:{name:'',connected:false,ip:'',mac:''}, network:{connected:false,ip:'',mac:''}, osName:'', osLastUpdate:'', avStatus:'', avScan:'' }
      return `
        <h3 class='text-lg font-bold mb-2'>${isNew? 'ุฅุถุงูุฉ ุฌูุงุฒ ุฌุฏูุฏ':'ุชุนุฏูู ุฌูุงุฒ'}</h3>
        <div class='grid grid-cols-1 gap-2'>
          <label>ุงุณู ุงูุฌูุงุฒ<input id='d_name' value='${escapeHtml(d.name)}' class='w-full rounded border px-2 py-1' /></label>
          <label>ุงููุณุชุฎุฏู
            <select id='d_user' class='w-full rounded border px-2 py-1'>
              <option value=''>-- ุงุฎุชุฑ ูุณุชุฎุฏู --</option>
              ${load(KEYS.USERS).map(u=>`<option value='${u.id}' ${u.id===d.userId? 'selected':''}>${escapeHtml(u.name)}</option>`).join('')}
            </select>
          </label>
          <label>ุงูุฑูู ุงูุชุณูุณูู<input id='d_sn' value='${escapeHtml(d.sn)}' class='w-full rounded border px-2 py-1' /></label>
          <label>ุงููุญุฏุฉ ุงููุฑูุฒูุฉ<input id='d_cpu' value='${escapeHtml(d.cpu)}' class='w-full rounded border px-2 py-1' /></label>
          <label>ุงูุดุงุดุฉ<input id='d_monitor' value='${escapeHtml(d.monitor)}' class='w-full rounded border px-2 py-1' /></label>
          <label>ุงููุฃุฑุฉ<input id='d_mouse' value='${escapeHtml(d.mouse)}' class='w-full rounded border px-2 py-1' /></label>
          <label>ููุญุฉ ุงูููุงุชูุญ<input id='d_keyboard' value='${escapeHtml(d.keyboard)}' class='w-full rounded border px-2 py-1' /></label>
          <label>ุงูุทุงุจุนุฉ - ุงูุงุณู<input id='p_name' value='${escapeHtml(d.printer?.name||'')}' class='w-full rounded border px-2 py-1' /></label>
          <label class='flex gap-2 items-center'><input id='p_connected' type='checkbox' ${d.printer?.connected? 'checked':''}/> ุงูุทุงุจุนุฉ ูุชุตูุฉ</label>
          <label>ุทุงุจุนุฉ IP<input id='p_ip' value='${escapeHtml(d.printer?.ip||'')}' class='w-full rounded border px-2 py-1' /></label>
          <label>ุทุงุจุนุฉ MAC<input id='p_mac' value='${escapeHtml(d.printer?.mac||'')}' class='w-full rounded border px-2 py-1' /></label>
          <label class='flex gap-2 items-center'><input id='net_connected' type='checkbox' ${d.network?.connected? 'checked':''}/> ุงูุฌูุงุฒ ูุชุตู ุจุงูุดุจูุฉ</label>
          <label>IP ุงูุฌูุงุฒ<input id='net_ip' value='${escapeHtml(d.network?.ip||'')}' class='w-full rounded border px-2 py-1' /></label>
          <label>MAC ุงูุฌูุงุฒ<input id='net_mac' value='${escapeHtml(d.network?.mac||'')}' class='w-full rounded border px-2 py-1' /></label>
          <label>ูุธุงู ุงูุชุดุบูู<input id='os_name' value='${escapeHtml(d.osName||'')}' class='w-full rounded border px-2 py-1' /></label>
          <label>ุขุฎุฑ ุชุญุฏูุซ ูููุธุงู<input id='os_update' type='date' value='${d.osLastUpdate||''}' class='w-full rounded border px-2 py-1' /></label>
          <label>ูุถุงุฏ ุงูููุฑูุณุงุช<input id='av_status' value='${escapeHtml(d.avStatus||'')}' class='w-full rounded border px-2 py-1' /></label>
          <label>ูุชูุฌุฉ ุงููุญุต<input id='av_scan' value='${escapeHtml(d.avScan||'')}' class='w-full rounded border px-2 py-1' /></label>
          <div class='flex justify-end gap-2 mt-2'>
            <button id='cancelModal' class='px-3 py-1 rounded border'>ุฅูุบุงุก</button>
            <button id='saveDevice' class='px-3 py-1 rounded bg-primary-600 text-white'>ุญูุธ</button>
          </div>
        </div>`
    }

    function attachDeviceFormHandlers(dev){
      $('#cancelModal').addEventListener('click', closeModal)
      $('#saveDevice').addEventListener('click', ()=>{
        try{
          const name = $('#d_name').value.trim()
          const sn = $('#d_sn').value.trim()
          if(!name || !sn) return alert('ุงุณู ุงูุฌูุงุฒ ูุงูุฑูู ุงูุชุณูุณูู ูุทููุจุงู')
          // ุชุญูู ุชูุฑุงุฑ SN ุนุงู
          const all = load(KEYS.DEV)
          if(!dev){ if(all.some(x=>x.sn===sn)){ alert('ููุฌุฏ ุฌูุงุฒ ุจููุณ ุงูุฑูู ุงูุชุณูุณูู. ุงูุฑุฌุงุก ุงูุชุญูู.'); return } }
          const counters = load(KEYS.COUNTERS)
          if(!dev) counters.dev = (counters.dev||0)+1
          // ุจูุงุก ุงููุงุฆู
          const obj = dev || { id: 'DEV-'+(counters.dev||0) }
          obj.name = name
          obj.userId = $('#d_user').value || ''
          obj.userName = ($('#d_user').selectedOptions[0]? $('#d_user').selectedOptions[0].text : '')
          obj.sn = sn
          obj.cpu = $('#d_cpu').value
          obj.monitor = $('#d_monitor').value
          obj.mouse = $('#d_mouse').value
          obj.keyboard = $('#d_keyboard').value
          obj.printer = { name: $('#p_name').value, connected: !!$('#p_connected').checked, ip: $('#p_ip').value, mac: $('#p_mac').value }
          obj.network = { connected: !!$('#net_connected').checked, ip: $('#net_ip').value, mac: $('#net_mac').value }
          obj.osName = $('#os_name').value
          obj.osLastUpdate = $('#os_update').value
          obj.avStatus = $('#av_status').value
          obj.avScan = $('#av_scan').value

          let arr = load(KEYS.DEV)
          if(dev){ arr = arr.map(x=> x.id===obj.id? obj:x) } else { arr.push(obj) }
          save(KEYS.DEV, arr)
          save(KEYS.COUNTERS, counters)
          pushRecent(dev? 'ุชุนุฏูู ุฌูุงุฒ: '+obj.name : 'ุฅุถุงูุฉ ุฌูุงุฒ: '+obj.name)
          closeModal()
          renderAll()
        }catch(err){ console.error(err); alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญูุธ') }
      })
    }

    function deleteDevice(id){ if(!confirm('ุญุฐู ุงูุฌูุงุฒ ููุงุฆููุงุ')) return; let arr=load(KEYS.DEV); arr = arr.filter(x=>x.id!==id); save(KEYS.DEV, arr); pushRecent('ุญุฐู ุฌูุงุฒ'); renderAll() }

    // ======= ุงููุณุชุฎุฏููู ======
    function renderUsers(){ const arr=load(KEYS.USERS); const tbody=$('#usersTbody'); tbody.innerHTML=''; arr.forEach((u,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td class='px-3 py-2'>${i+1}</td><td class='px-3 py-2'>${u.name}</td><td class='px-3 py-2'>${u.speciality||''}</td><td class='px-3 py-2'>${(u.certs||[]).map(c=>c.name+' ('+c.date+')').join('<br>')}</td><td class='px-3 py-2'><button data-id='${u.id}' class='editUser px-2 py-1 rounded border'>ุชุนุฏูู</button><button data-id='${u.id}' class='delUser px-2 py-1 rounded border ml-2'>ุญุฐู</button></td>`; tbody.appendChild(tr) })
      $$('.editUser').forEach(b=>b.addEventListener('click', e=>openUserModal(e.target.dataset.id)))
      $$('.delUser').forEach(b=>b.addEventListener('click', e=>{ if(!confirm('ุญุฐู ุงููุณุชุฎุฏูุ'))return; let arr=load(KEYS.USERS); arr=arr.filter(x=>x.id!==e.target.dataset.id); save(KEYS.USERS,arr); pushRecent('ุญุฐู ูุณุชุฎุฏู'); renderAll() })) }

    function openUserModal(id){ const user = load(KEYS.USERS).find(x=>x.id==id)||null; const html = renderUserForm(user); openModal(html); attachUserHandlers(user) }

    function renderUserForm(user){ const isNew=!user; const u=user||{name:'',speciality:'',certs:[]}; return `
      <h3 class='text-lg font-bold mb-2'>${isNew? 'ุฅุถุงูุฉ ูุณุชุฎุฏู':'ุชุนุฏูู ูุณุชุฎุฏู'}</h3>
      <label>ุงูุงุณู<input id='u_name' value='${escapeHtml(u.name)}' class='w-full rounded border px-2 py-1' /></label>
      <label>ุงูุงุฎุชุตุงุต<input id='u_spec' value='${escapeHtml(u.speciality||'')}' class='w-full rounded border px-2 py-1' /></label>
      <div class='mt-2'>ุงูุดูุงุฏุงุช (ุงุถู ูุงุญุฏุฉ ุชูู ุงูุฃุฎุฑู)</div>
      <div class='flex gap-2 mt-2'>
        <input id='cert_name' placeholder='ุงุณู ุงูุดูุงุฏุฉ' class='rounded border px-2 py-1 w-2/3' />
        <input id='cert_date' type='date' class='rounded border px-2 py-1 w-1/3' />
      </div>
      <div class='mt-2 flex justify-end gap-2'>
        <button id='cancelUser' class='px-3 py-1 rounded border'>ุฅูุบุงุก</button>
        <button id='addCert' class='px-3 py-1 rounded border'>ุฃุถู ุดูุงุฏุฉ</button>
        <button id='saveUser' class='px-3 py-1 rounded bg-primary-600 text-white'>ุญูุธ</button>
      </div>
      <div id='certList' class='mt-3'>${(u.certs||[]).map(c=>`<div class='text-sm'>${escapeHtml(c.name)} โ ${c.date}</div>`).join('')}</div>` }

    function attachUserHandlers(user){ $('#cancelUser').addEventListener('click', closeModal); $('#addCert').addEventListener('click', ()=>{ const name=$('#cert_name').value.trim(); const date=$('#cert_date').value; if(!name||!date) return alert('ุงุฏุฎู ุงุณู ูุชุงุฑูุฎ ุงูุดูุงุฏุฉ'); const list = load(KEYS.USERS); const temp = user? (user.certs||[]) : []; temp.push({name,date}); $('#certList').innerHTML = temp.map(c=>`<div class='text-sm'>${escapeHtml(c.name)} โ ${c.date}</div>`).join(''); user? user.certs=temp : user={...user,certs:temp}; $('#cert_name').value=''; $('#cert_date').value=''; }); $('#saveUser').addEventListener('click', ()=>{ const name=$('#u_name').value.trim(); if(!name) return alert('ุงูุงุณู ูุทููุจ'); const arr=load(KEYS.USERS); const counters=load(KEYS.COUNTERS); if(!user){ counters.user=(counters.user||0)+1; const id='USR-'+counters.user; const obj={id,name,speciality:$('#u_spec').value,certs:[]}; arr.push(obj); save(KEYS.USERS,arr); save(KEYS.COUNTERS,counters); pushRecent('ุฅุถุงูุฉ ูุณุชุฎุฏู: '+name); } else { const obj={...user,name,speciality:$('#u_spec').value}; const newArr=arr.map(x=> x.id===user.id? obj:x); save(KEYS.USERS,newArr); pushRecent('ุชุนุฏูู ูุณุชุฎุฏู: '+name); } closeModal(); renderAll(); }) }

    // ======= C12/C7 ======
    function renderC12(){ const arr=load(KEYS.C12); const tbody=$('#c12Tbody'); tbody.innerHTML=''; arr.forEach((r,i)=>{ const d=load(KEYS.DEV).find(x=>x.id===r.deviceId)||{}; const tr=document.createElement('tr'); tr.innerHTML=`<td class='px-3 py-2'>${i+1}</td><td class='px-3 py-2'>${r.number}</td><td class='px-3 py-2'>${r.date}</td><td class='px-3 py-2'>${d.name||r.deviceName||''}</td><td class='px-3 py-2'>${r.recipient||''}</td><td class='px-3 py-2'>${r.entity||''}</td><td class='px-3 py-2'><button data-i='${i}' class='printC12 px-2 py-1 rounded border'>ุทุจุงุนุฉ</button><button data-i='${i}' class='delC12 px-2 py-1 rounded border ml-2'>ุญุฐู</button></td>`; tbody.appendChild(tr) })
      $$('.delC12').forEach(b=>b.addEventListener('click', e=>{ if(!confirm('ุญุฐู ูุซููุฉุ')) return; let arr=load(KEYS.C12); arr.splice(e.target.dataset.i,1); save(KEYS.C12,arr); pushRecent('ุญุฐู C12'); renderAll(); }))
      $$('.printC12').forEach(b=>b.addEventListener('click', e=>printC12(e.target.dataset.i))) }

    function renderC7(){ const arr=load(KEYS.C7); const tbody=$('#c7Tbody'); tbody.innerHTML=''; arr.forEach((r,i)=>{ const d=load(KEYS.DEV).find(x=>x.id===r.deviceId)||{}; const tr=document.createElement('tr'); tr.innerHTML=`<td class='px-3 py-2'>${i+1}</td><td class='px-3 py-2'>${r.number}</td><td class='px-3 py-2'>${r.date}</td><td class='px-3 py-2'>${d.name||r.deviceName||''}</td><td class='px-3 py-2'>${r.issue||''}</td><td class='px-3 py-2'>${r.status||''}</td><td class='px-3 py-2'><button data-i='${i}' class='printC7 px-2 py-1 rounded border'>ุทุจุงุนุฉ</button><button data-i='${i}' class='delC7 px-2 py-1 rounded border ml-2'>ุญุฐู</button></td>`; tbody.appendChild(tr) })
      $$('.delC7').forEach(b=>b.addEventListener('click', e=>{ if(!confirm('ุญุฐู ูุซููุฉ ุตูุงูุฉุ')) return; let arr=load(KEYS.C7); arr.splice(e.target.dataset.i,1); save(KEYS.C7,arr); pushRecent('ุญุฐู C7'); renderAll() }))
      $$('.printC7').forEach(b=>b.addEventListener('click', e=>printC7(e.target.dataset.i))) }

    function printC12(i){ const arr=load(KEYS.C12); const r=arr[i]; const d = load(KEYS.DEV).find(x=>x.id===r.deviceId)||{}; const html = buildPrintHTML('C12', r, d); const w=window.open('','_blank'); w.document.write(html); w.document.close(); w.print(); }
    function printC7(i){ const arr=load(KEYS.C7); const r=arr[i]; const d = load(KEYS.DEV).find(x=>x.id===r.deviceId)||{}; const html = buildPrintHTML('C7', r, d); const w=window.open('','_blank'); w.document.write(html); w.document.close(); w.print(); }
    function buildPrintHTML(type, rec, device){ return `<!doctype html><html lang='ar' dir='rtl'><head><meta charset='utf-8'><title>${type} ${rec.number}</title><style>body{font-family:Arial;padding:20px}table{width:100%;border-collapse:collapse}td,th{border:1px solid #444;padding:8px;text-align:right}</style></head><body><h2>ูููุฐุฌ ${type}</h2><table><tr><th>ุฑูู ุงููุซููุฉ</th><td>${rec.number}</td></tr><tr><th>ุงูุชุงุฑูุฎ</th><td>${rec.date}</td></tr><tr><th>ุงุณู ุงูุฌูุงุฒ</th><td>${device.name||rec.deviceName||''}</td></tr>${type==='C7'?`<tr><th>ุงูุนุทู</th><td>${rec.issue||''}</td></tr><tr><th>ุงูุญุงูุฉ</th><td>${rec.status||''}</td></tr>`:`<tr><th>ุงููุณุชูู</th><td>${rec.recipient||''}</td></tr><tr><th>ุงูุฌูุฉ</th><td>${rec.entity||''}</td></tr>`}</table><p style='margin-top:20px'>ุชูููุน: ___________________</p></body></html>` }// ====== ุฅูุดุงุก ูุซุงุฆู ุฌุฏูุฏุฉ ======
$('#addDeviceBtn').addEventListener('click', ()=>{ openModal(renderDeviceForm(null)); attachDeviceFormHandlers(null) })
$('#addUserBtn').addEventListener('click', ()=>{ openModal(renderUserForm(null)); attachUserHandlers(null) })

$('#addC12Btn').addEventListener('click', ()=>{
  const devs = load(KEYS.DEV)
  if(devs.length===0) return alert('ูุง ุฃุฌูุฒุฉ ูุณุฌูุฉ')
  const counters = load(KEYS.COUNTERS); counters.c12=(counters.c12||0)+1; save(KEYS.COUNTERS,counters)
  const id = 'C12-'+counters.c12
  const date = new Date().toISOString().slice(0,10)
  // ุงุฎุชุฑ ุงูุฌูุงุฒ ุจูุงุณุทุฉ ูุงูุฐุฉ ุจุณูุทุฉ
  const sel = prompt('ุฃุฏุฎู ุฑูู ุงูุฌูุงุฒ (ID) ุฃู ุงูุฑูู ุงูุชุณูุณูู ูุชุณุฌูู ุงูุชุณููู:')
  if(!sel) return
  const device = devs.find(d=>d.id===sel || d.sn===sel)
  const deviceName = device? device.name : sel
  const recipient = prompt('ุงุณู ุงููุณุชูู ุฃู ุงูุฌูุฉ:')||''
  const entity = prompt('ุงูุฌูุฉ ุงูุชู ุณููุช ุงูุฌูุงุฒ:')||''
  const rec = { number:id, date, deviceId: device? device.id : '', deviceName, recipient, entity }
  const arr = load(KEYS.C12); arr.push(rec); save(KEYS.C12,arr); pushRecent('ุฅูุดุงุก C12 '+id); renderAll()
})

$('#addC7Btn').addEventListener('click', ()=>{
  const devs = load(KEYS.DEV)
  if(devs.length===0) return alert('ูุง ุฃุฌูุฒุฉ ูุณุฌูุฉ')
  const counters = load(KEYS.COUNTERS); counters.c7=(counters.c7||0)+1; save(KEYS.COUNTERS,counters)
  const id = 'C7-'+counters.c7
  const date = new Date().toISOString().slice(0,10)
  const sel = prompt('ุฃุฏุฎู ุฑูู ุงูุฌูุงุฒ (ID) ุฃู ุงูุฑูู ุงูุชุณูุณูู ูุฅุฑุณุงู ููุตูุงูุฉ:')
  if(!sel) return
  const device = devs.find(d=>d.id===sel || d.sn===sel)
  const deviceName = device? device.name : sel
  const issue = prompt('ูุตู ุงูุนุทู ุงููุญุชูู:')||''
  const rec = { number:id, date, deviceId: device? device.id : '', deviceName, issue, status:'ููุฏ ุงูุฅุตูุงุญ' }
  const arr = load(KEYS.C7); arr.push(rec); save(KEYS.C7,arr); pushRecent('ุฅูุดุงุก C7 '+id); renderAll()
})

// ====== Export / Import ุดุงูู ======
$('#exportAll').addEventListener('click', ()=>{
  const wb = XLSX.utils.book_new()
  const dev = load(KEYS.DEV)
  const users = load(KEYS.USERS)
  const c12 = load(KEYS.C12)
  const c7 = load(KEYS.C7)
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(dev),'Devices')
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(users),'Users')
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(c12),'C12')
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(c7),'C7')
  XLSX.writeFile(wb, 'inventory_export.xlsx')
})

$('#importAll').addEventListener('change', (ev)=>{
  const f = ev.target.files[0]
  if(!f) return
  const reader = new FileReader()
  reader.onload = (e)=>{
    const data = new Uint8Array(e.target.result)
    const wb = XLSX.read(data,{type:'array'})
    const names = wb.SheetNames
    if(names.includes('Devices')) save(KEYS.DEV, XLSX.utils.sheet_to_json(wb.Sheets['Devices'], {defval:''}))
    if(names.includes('Users')) save(KEYS.USERS, XLSX.utils.sheet_to_json(wb.Sheets['Users'], {defval:''}))
    if(names.includes('C12')) save(KEYS.C12, XLSX.utils.sheet_to_json(wb.Sheets['C12'], {defval:''}))
    if(names.includes('C7')) save(KEYS.C7, XLSX.utils.sheet_to_json(wb.Sheets['C7'], {defval:''}))
    pushRecent('ุงุณุชูุฑุงุฏ ููู Excel')
    renderAll()
    alert('ุชู ุงูุงุณุชูุฑุงุฏ ุจูุฌุงุญ. ุชุญูู ูู ุงูุจูุงูุงุช.')
  }
  reader.readAsArrayBuffer(f)
})

// ======= ุชููุฆุฉ ูุงุนุฏุฉ ุฌุฏูุฏุฉ ======
$('#resetData').addEventListener('click', ()=>{ if(!confirm('ุณูุคุฏู ุฐูู ูุชููุฆุฉ ูุงุนุฏุฉ ุฌุฏูุฏุฉ (ุณูุจูู ุงููุณุฎ ุงูุณุงุจู ุฅู ุฃุฑุฏุช ุญูุธู). ูุชุงุจุนุฉุ')) return; localStorage.clear(); initDB(); renderAll(); pushRecent('ุชููุฆุฉ ูุงุนุฏุฉ ุฌุฏูุฏุฉ') })

// ======= ููุงุฐุฌ ุงูููุฏุงู ======
function openModal(html){ $('#modals').classList.remove('hidden'); $('#modalContent').innerHTML = html }
function closeModal(){ $('#modals').classList.add('hidden'); $('#modalContent').innerHTML = '' }

// ======= ูุณุงุนุฏุฉ ุทุจุงุนุฉ/escape ======
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;') }

// ====== ุจุญุซ ุนุงู ======
$('#globalSearch').addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase(); if(!q){ renderAll(); return }
  // ุจุญุซ ูุจุณุท: ุงูุฌูุงุฒ ุจุงุณู ุฃู SN ุฃู ูุณุชุฎุฏู
  const devs = load(KEYS.DEV).filter(d=> (d.name||'').toLowerCase().includes(q) || (d.sn||'').toLowerCase().includes(q) || (d.userName||'').toLowerCase().includes(q))
  // ุนุฑุถ ุงููุชุงุฆุฌ ููุท ูู ุฌุฏูู ุงูุฃุฌูุฒุฉ
  const tbody = $('#devicesTbody'); tbody.innerHTML=''
  devs.forEach((d,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td class='px-3 py-2'>${i+1}</td><td class='px-3 py-2'>${d.name}</td><td class='px-3 py-2'>${d.userName||''}</td><td class='px-3 py-2'>${d.sn}</td><td class='px-3 py-2'>${d.network.connected?d.network.ip:'ูุนุฒูู'}</td><td class='px-3 py-2'>${d.osName||''}</td><td class='px-3 py-2'>${d.avStatus||''}</td><td class='px-3 py-2'></td>`; tbody.appendChild(tr) })
})

// ====== ุงูุจุฏุก ======
window.addEventListener('DOMContentLoaded', ()=>{ initDB(); renderAll(); })

  </script>
</body>
</html>